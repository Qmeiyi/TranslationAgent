# C同学功能测试运行指南

## 快速测试步骤

### 1. 环境准备

确保已安装依赖并配置API密钥：

```bash
# 安装依赖
pip install -r requirements.txt

# 设置环境变量（Windows PowerShell）
$env:SILICONFLOW_API_KEY="your_api_key"
# 或
$env:OPENAI_API_KEY="your_api_key"
```

### 2. 先用dry_run测试流程（不调用LLM）

测试工作流和数据结构是否正确：

```bash
# 测试完整流程（不调用LLM，只测试数据流）
python src/main.py --input_path data/processed/诡秘之主_final.jsonl --chapters 1 --dry_run
```

这会：
- ? 测试术语提取的数据结构
- ? 测试GlossaryStore的冲突解决逻辑
- ? 测试工作流节点连接
- ? 生成测试用的glossary和chunk文件

**检查输出**：
- `data/runs/<run_id>/glossary/glossary_v1.json` - 术语表文件
- `data/runs/<run_id>/logs/run.log` - 运行日志（查看冲突解决报告）
- `data/runs/<run_id>/chunks/` - chunk输出（包含violations字段）

### 3. 小规模真实测试（调用LLM）

测试C同学的术语一致性检查功能：

```bash
# 只测试第1章，限制chunk数量
python src/main.py --input_path data/processed/诡秘之主_final.jsonl --chapters 1 --max_chunks_per_chapter 2
```

这会：
- ? 真实提取术语（多类别）
- ? 处理术语冲突
- ? 翻译时检查术语一致性
- ? 自动纠正违规

### 4. 查看C同学功能的输出

#### 4.1 查看Glossary文件（版本化）

```bash
# Windows PowerShell
Get-Content data/runs/<run_id>/glossary/glossary_v*.json | Select-Object -First 50
```

检查点：
- ? 文件名为 `glossary_v1.json`, `glossary_v2.json` 等（版本化）
- ? 包含 `version` 字段
- ? `entries` 中包含 `type`, `candidates`, `evidence_span` 等字段
- ? 多义词有 `senses` 字段

#### 4.2 查看冲突解决报告

```bash
# 查看日志中的冲突解决信息
Get-Content data/runs/<run_id>/logs/run.log | Select-String "glossary"
```

应该看到类似：
```
[glossary] 处理了 X 个术语冲突
[glossary] 冲突: 值夜者 - merged
[glossary] 合并了 Y 个术语
```

#### 4.3 查看术语违规检测（violations）

```bash
# 查看chunk输出中的violations
Get-Content data/runs/<run_id>/chunks/1/1-001.json
```

检查点：
- ? `violations` 字段存在
- ? 如果翻译中未使用术语，会有违规记录
- ? 违规包含 `term`, `expected`, `found`, `severity` 等字段

#### 4.4 查看最终翻译结果

```bash
# 查看章节翻译
Get-Content data/runs/<run_id>/final/chapters/chapter_1_zh.txt

# 查看合并后的全书
Get-Content data/runs/<run_id>/final/book_merged_zh.txt
```

### 5. 验证C同学的核心功能

#### 5.1 验证术语分类提取

检查 `glossary_v1.json` 中的术语类型：
- ? `NE:person` - 人名
- ? `NE:location` - 地名  
- ? `NE:org` - 组织名
- ? `slang` - 俚语
- ? `domain_term` - 领域术语
- ? `culture_loaded` - 文化负载词

#### 5.2 验证冲突解决

运行两次提取，查看版本号是否递增：
```bash
# 第一次运行
python src/main.py --input_path data/processed/诡秘之主_final.jsonl --chapters 1-2 --dry_run
# 记录run_id

# 第二次运行（应该会合并冲突）
python src/main.py --input_path data/processed/诡秘之主_final.jsonl --chapters 1-3 --dry_run
```

检查：
- ? 第二次运行后，glossary版本号+1
- ? 日志中显示冲突处理信息

#### 5.3 验证术语一致性检查

查看翻译结果中的violations：
```python
import json
from pathlib import Path

# 读取chunk输出
chunk_file = Path("data/runs/<run_id>/chunks/1/1-001.json")
data = json.loads(chunk_file.read_text(encoding="utf-8"))

# 检查violations
violations = data.get("violations", [])
print(f"发现 {len(violations)} 个术语违规")
for v in violations:
    print(f"  - {v['term']}: 期望 '{v['expected']}', 但 {v['found']}")
```

#### 5.4 验证自动纠正

如果发现high/medium严重度的违规，应该：
- ? 自动触发纠正流程
- ? 纠正后的翻译在 `final_translation` 字段
- ? 纠正后再次检查，违规应该减少

### 6. 完整测试（可选）

```bash
# 测试多章节
python src/main.py --input_path data/processed/诡秘之主_final.jsonl --chapters 1-3
```

### 7. 常见问题排查

#### 问题1：ImportError: cannot import name 'GlossaryStore'
```bash
# 确保在项目根目录运行
cd C:\Users\13249\Desktop\LLM大作业\TranslationAgent
python src/main.py ...
```

#### 问题2：API Key未设置
```bash
# Windows PowerShell
$env:SILICONFLOW_API_KEY="your_key"
# 或使用 .env 文件
```

#### 问题3：想查看详细日志
```bash
# 查看完整日志
Get-Content data/runs/<run_id>/logs/run.log
```

### 8. 测试检查清单

- [ ] dry_run模式能正常运行
- [ ] glossary文件生成，格式为 `glossary_v{version}.json`
- [ ] glossary包含多类别术语（NE:person, slang等）
- [ ] 日志中显示冲突解决信息
- [ ] chunk输出包含 `violations` 字段
- [ ] 术语违规能被检测到
- [ ] 自动纠正功能工作正常
- [ ] 最终翻译结果质量良好

## 快速测试命令总结

```bash
# 1. 流程测试（dry_run）
python src/main.py --input_path data/processed/诡秘之主_final.jsonl --chapters 1 --dry_run

# 2. 小规模真实测试
python src/main.py --input_path data/processed/诡秘之主_final.jsonl --chapters 1 --max_chunks_per_chapter 2

# 3. 查看结果
# - Glossary: data/runs/<run_id>/glossary/glossary_v1.json
# - 日志: data/runs/<run_id>/logs/run.log  
# - 违规: data/runs/<run_id>/chunks/<chapter_id>/<chunk_id>.json
# - 翻译: data/runs/<run_id>/final/chapters/chapter_1_zh.txt
```

